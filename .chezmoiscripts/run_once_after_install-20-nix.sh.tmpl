{{- if (eq .chezmoi.os "darwin") -}}

#!/bin/bash

set -x

read -r -d '' CONFIG << EOM
# Generated by https://github.com/DeterminateSystems/nix-installer, version 0.8.0.
bash-prompt-prefix = (nix:$name)\040
build-users-group = nixbld
extra-nix-path = nixpkgs=flake:nixpkgs
experimental-features = nix-command flakes
auto-optimise-store = true

# cachix use nix-community
trusted-users = root zerodeth
EOM

if [ -f "/etc/nix/nix.conf" ]; then
    if ! grep -Fxq "$CONFIG" /etc/nix/nix.conf
    then
        echo "$CONFIG" | awk '{$1=$1};1' | sudo tee -a /etc/nix/nix.conf && sudo pkill nix-daemon
        if [ $? -eq 0 ]; then echo "Success"; else echo "Failed"; fi
    else
        echo "Configuration already present"
    fi
else
    echo "/etc/nix/nix.conf does not exist. Please create one..."
fi

{{ end -}}
